---
title: "Mjerenje uspješnosti investicijskih fondova"
output: pdf_document
---
# Priprema podataka
```{r}
source_eval <- function(file) source(file, print.eval = TRUE)
source_eval('uncommon.r')

source('data_extraction.r')
xs <- read_normalize(CSV_DATA)
```


# Priprema i analiza podataka

## Podjela prema tipovima fondova

```{r}
investment_funds <- c("ERSTEAdriaticEquity", "OTPMeridian20", "ZBAktiv")
pension_funds <- c("RaiffeisenDMF", "ERSTEPlaviEXPERT", "ERSTEPlaviPROTECT")
all_funds <- c(investment_funds, pension_funds)
market_portfolio <- c("CROBEX")

xs.market_portfolio <- to_data_frame(xs, market_portfolio, xs.market_portfolio)
xs.investment <- to_data_frame(xs, investment_funds, xs.investment)
xs.pension <- to_data_frame(xs, pension_funds, xs.pension)

data_columns <- c(pension_funds, investment_funds, market_portfolio)
xs.funds <- xs[, data_columns]

```

## Povrati

Računanje dnevnih povrata
```{r}
diff_function_log <- function(St, St_minus_one) log(St) - log(St_minus_one)
xs.returns <- to_time_series_diff_df(xs, data_columns, diff_function_log)

#diff_function_sub <- function(St, St_minus_one) St - St_minus_one
#xs.returns <- to_time_series_diff_df(xs, data_columns, diff_function_sub)

```


## Sažeci
```{r}
xs.summary <- summary(xs.funds)
xs.returns.summary <- summary(xs.returns[data_columns] * 365)
# xs.log_returns.summary <- summary(xs.log_returns[data_columns])

df_summary <- function(summary) {
  return(data.frame(unclass(summary), check.names = FALSE, stringsAsFactors = FALSE))
}

df_summary(xs.returns.summary)
```


## Mjere raspršenosti
```{r}

apply(xs.returns[all_funds] * 365, 2, var, na.rm=T) 
apply(xs.returns[all_funds] * sqrt(365), 2, sd, na.rm=T)

```

# Grafički prikaz podataka
```{r include=FALSE}
source('plotting.r')
require(reshape2)
```

## Prikaz vrijednosti CROBEX-a po danima
```{r}
ggplot(xs, aes(Date, CROBEX)) + geom_line()
```

## Prikaz vrijednosti investicijskih i mirovinskih fondova po danima 

```{r}
df <- melt(xs[c("Date", investment_funds, pension_funds)], 
           id.vars = 'Date', 
           variable.name = 'Fondovi')
ggplot(df, aes(Date, value)) + geom_line(aes(colour = Fondovi))
```

## Prikaz boxplotova za sve fondove

Iz ovih se grafova vidi kako su investicijski fondovi (prva tri stupca) podložniji većim promjenama vrijednosti od mirovinskih na dnevnoj bazi.

```{r warning=FALSE}

df.returns <- melt(xs.returns[c("Date", investment_funds, pension_funds)], 
                   id.vars = 'Date', 
                   variable.name = 'Fondovi')
```

```{r}
library(stringr)

label_prettify <- function(label) {
  first_matches <- str_match(label, "(^[A-Z]+)([A-Z][a-z]+)(.*)")
  second_matches <- str_match(label, "(^[A-Z][a-z]+)([A-Z]+)")
  
  first_word <- ifelse(!is.na(first_matches[1, 1]), first_matches[1, 2], second_matches[1, 2])
  second_word <- ifelse(!is.na(first_matches[1, 1]), first_matches[1, 3], second_matches[1, 3])
  second_word <- ifelse(!is.na(first_matches[1, 4]), str_c(second_word, first_matches[1, 4], sep = " "), second_word)
  
  return(str_c(first_word, second_word,sep = " ") %>% str_wrap(width = 10))
}

ggplot(df.returns, aes(Date, value)) + 
  geom_boxplot(aes(Fondovi)) + 
  xlab("Fondovi") + 
  ylab("Povrati") +
  scale_x_discrete(labels = function(labels) return(lapply(labels, label_prettify)))

```


## Provjera normalnosti

Sljedećim QQ grafovima želimo ispitati normalnost distribucije burzovnog indeksa. Iz QQ grafa vidimo kako podaci nisu u potpunosti normalni, a iz histograma jasno je i zašto. Teške repove primjećujemo radi sitne granulacije, tj. dnevnog računanja prinosa; u tako kratkom roku zna se dogoditi da pojedina dionica ili naglo naraste ili naglo padne u vrijednosti.

```{r}
library(magrittr)
plot_returns <- function(fund.returns, fund.name) hist(fund.returns, 
                                                       main = fund.name, 
                                                       density=20, 
                                                       xlab='Log returns', 
                                                       labels=TRUE, 
                                                       breaks=10)
mapply(plot_returns, 
       c(xs.returns[c(pension_funds, investment_funds)]), 
       c(pension_funds, investment_funds)) %>% 
  invisible

```

TODO: Kolmogorov-smirnov

```{r}

qqplots <- function(fund.returns, fund.name) {
  qqnorm(fund.returns, main = fund.name) 
  qqline(fund.returns)
}

mapply(qqplots, 
       c(xs.returns[c(pension_funds, investment_funds)]), 
       c(pension_funds, investment_funds)) %>% 
  invisible

#PerformanceAnalytics::chart.QQPlot(xs.returns$ZBAktiv)
#PerformanceAnalytics::chart.Regression(zbaktiv.ts, capm.m.ts, capm.rf.2010,
#                                       excess.returns = TRUE, fit = c("loess", "linear"))
#PerformanceAnalytics::SharpeRatio(capm.m.ts)

# xs.log_returns <- lapply( xs[columns_to_log_normalize], function(list) time_series_diff(list, diff_function) )
# xs.log_returns <- data.frame( c(xs[2:nrow(xs), !(colnames(xs) %in% columns_to_log_normalize)], xs.log_returns) )
#xs.xts <- xts(xs['CROBEX'], order.by = xs$Date)

```


# Testovi fondova

Iako QQ grafovi pokazuju da povrati nisu normalno raspodijeljeni, radimo tu pretpostavku s obzirom na robusnost T-testa. Jasno je da globalni događaji (kriza, teroristički napadi,...) često utječu na cijelo tržište odjednom, pa koristimo T-testove za uparene podatke.


## Testovi povrata investicijskih fondova u odnosu na CROBEX
```{r}
compare.to.index <- function(index) function(fund.returns) t.test(index, fund.returns, 
                                                                  paired = TRUE)
mapply(compare.to.index(xs.returns$CROBEX), xs.returns[investment_funds])
```


## Testovi povrata mirovinskih fondova u odnosu na CROBEX

```{r}
mapply(compare.to.index(xs.returns$CROBEX), xs.returns[pension_funds])
```


## Test povrata investicijskih fondova u odnosu na mirovinske fondove

Izračunate su sredine mirovinskih i investicijskih fondova pa je sproveden test njihovih vrijednosti. Dobivamo izrazito malu p-vrijednost, stoga uz relativno veliku sigurnost zaključujemo da možemo odbaciti nul-hipotezu koja tvrdi da su sredine jednake.

```{r}
grouped.return.means = data.frame(Date = xs.returns$Date, 
                                  MeansPension = rowMeans(xs.returns[pension_funds]),
                                  MeansInvestment = rowMeans(xs.returns[investment_funds]))

t.test(grouped.return.means$MeansPension, grouped.return.means$MeansInvestment, paired = TRUE)
```


# CAPM model

```{r}
dates <- xs.returns$Date

year <- function(date) format(date, "%Y")
get_for_year <- function(df, dates, desired_year) df[year(dates) == desired_year, ]

xs.2010 <- get_for_year(xs.returns, xs.returns$Date, 2010)

zbaktiv.2010 <- xs.2010$ZBAktiv #xs.2010[c('Date', 'ZBAktiv')]
capm.market.2010 <- xs.2010$CROBEX #xs.2010[c('Date', 'CROBEX')]
capm.risk_free.2010 <- xs.2010$InterestRate.daily #[c('Date', 'InterestRate.daily')]
zbaktiv.model <- lm(formula = (zbaktiv.2010 - capm.risk_free.2010) ~ (capm.market.2010 - capm.risk_free.2010))
```

## Provjera reziduala

TODO: regresija / vrijednosti i raspodjela reziduala

```{r}
# https://www.r-bloggers.com/r-tutorial-series-simple-linear-regression/

zbaktiv.model.summary <- summary(zbaktiv.model)
zbaktiv.model.residuals <- zbaktiv.model.summary$residuals

hist(zbaktiv.model.residuals)
plot(zbaktiv.model.residuals)

qqnorm(rstandard(zbaktiv.model))
qqline(rstandard(zbaktiv.model))

ks.test(rstandard(zbaktiv.model), 'pnorm')
```

# CAPM model 2

TODO: tablica modela (alpha / beta) <- VERIFY

```{r}
require(quantmod)
require(PerformanceAnalytics)
library(xts)

get_capm_for_year <- function(df, fund, desired_year){
  xs.year = get_for_year(df, df$Date, desired_year)
  
  fund.year <- xs.year[c('Date', fund)]
  fund.ts <- xts(fund.year[, -1], order.by=fund.year$Date)
  
  capm.index.year <- xs.year[c('Date', 'CROBEX')]
  capm.index.ts <-  xts(capm.index.year[, -1], order.by=capm.index.year$Date)
  
  capm.risk_free.year <- xs.year[c('Date', 'InterestRate.daily')]
  capm.risk_free.year <- capm.risk_free.year[1, -1]
  
  data.frame(fund, as.factor(desired_year),
             CAPM.alpha(fund.ts, capm.index.ts, capm.risk_free.year), 
             CAPM.beta(fund.ts, capm.index.ts, capm.risk_free.year))
}

xs.years = seq(from = 2010, by = 1, length = 7)
xs.fund.names = c(investment_funds, pension_funds)
xs.capm <- data.frame(matrix(ncol = 3, nrow = 0))

for (i in 1:length(xs.fund.names)){
  for (j in 1:length(xs.years)){
    xs.capm <- rbind(xs.capm, get_capm_for_year(xs.returns, xs.fund.names[i], xs.years[j]))
  }
}

colnames(xs.capm) <- c("Fund", "Year", "Alpha", "Beta")
xs.capm

ggplot(xs.capm, aes(Year, Beta, color= Fund, group = Fund)) + 
  geom_point() + geom_line()
ggplot(xs.capm, aes(Year, Alpha, color= Fund, group = Fund)) + 
  geom_point() + geom_line()

```

# ANOVA
```{r}

zbaktiv.2010 - (xs.2010$CROBEX )

```

